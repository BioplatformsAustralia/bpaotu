# Base image: use the same as Dockerfile-base
FROM python:3.9-slim-bullseye

# System packages
# git; required for pip packages on github
# ncbi-blast+; required for BLAST search
# gdal-bin, libgeos-3.9.0; required by django.contrib.gis.db.backends.postgis database engine
RUN apt-get update && apt-get install -y --no-install-recommends \
  git \
  ncbi-blast+ \
  gdal-bin \
  libgeos-3.9.0 \
  && apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*;

# uid and gid must match runserver Dockerfile
RUN addgroup --gid 1000 bioplatforms \
  && adduser --disabled-password --home /data --no-create-home --system -q --uid 1000 --ingroup bioplatforms bioplatforms \
  && mkdir /data /app \
  && chown bioplatforms:bioplatforms /data

WORKDIR /app

COPY ./requirements/worker-requirements.txt /app/bpaotu/
RUN pip install --no-cache-dir --upgrade -r bpaotu/worker-requirements.txt

COPY . /app

# Ensure worker entrypoint script is executable
RUN chmod +x /app/docker-worker-entrypoint.sh

# Notes:
# Don't set HOME to /app because other containers used /data as home

# Switch to non-root user
USER bioplatforms

# Run the celery worker when container starts
# Default CMD provided for docker compose (puppet runs command explicitly)
ENTRYPOINT ["/app/docker-worker-entrypoint.sh"]
CMD ["celery_worker"]
